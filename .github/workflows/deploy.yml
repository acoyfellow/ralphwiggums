name: Deploy with Ralph Loop

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, reopened, synchronize, closed]

env:
  # Stage determined by event type
  STAGE: >-
    ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || (github.ref == 'refs/heads/main' && 'prod' || github.ref_name) }}
  # Retry configuration for Ralph Loop
  MAX_RETRIES: 5
  RETRY_DELAY: 5

# Concurrency: Prevent overlapping deployments for same ref
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build project
        run: bun run build

      - name: Verify build output
        run: |
          if [ ! -f "dist/src/index.js" ]; then
            echo "‚ùå Build output not found: dist/src/index.js"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      - name: Verify SvelteKit build
        run: |
          if [ ! -d ".svelte-kit" ]; then
            echo "‚ùå SvelteKit build directory not found"
            exit 1
          fi
          echo "‚úÖ SvelteKit build verified"

      - name: Run test suite
        run: bun test src/__tests__/

  deploy:
    name: Deploy
    needs: test
    if: ${{ github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Deploy to environment
        run: bun alchemy deploy --stage ${{ env.STAGE }}
        env:
          STAGE: ${{ env.STAGE }}
          ALCHEMY_PASSWORD: ${{ secrets.ALCHEMY_PASSWORD }}
          ALCHEMY_STATE_TOKEN: ${{ secrets.ALCHEMY_STATE_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ZEN_API_KEY: ${{ secrets.ZEN_API_KEY }}
          RALPH_API_KEY: ${{ secrets.RALPH_API_KEY }}
          PULL_REQUEST: ${{ github.event.number }}
          GITHUB_SHA: ${{ github.sha }}
          ALCHEMY_CI_STATE_STORE_CHECK: false

  route-floop:
    name: Ralph Loop (Health Check with Error Loop)
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Wait for deployment
        run: sleep 30

      - name: Ralph Loop - Health Check with Max 5 Retries
        id: health-check
        uses: nick-fields/retry-action@v2
        with:
          timeout_minutes: 5
          max_attempts: ${{ env.MAX_RETRIES }}
          retry_wait_seconds: ${{ env.RETRY_DELAY }}
          on_retry_command: |
            echo "‚ö†Ô∏è Ralph Loop: Health check failed (attempt ${{ steps.health-check.outputs.attempt }}/${{ env.MAX_RETRIES }})"
            echo "Waiting ${{ env.RETRY_DELAY }}s before retry..."
          command: |
            STAGE="${{ env.STAGE }}"

            # Determine URL based on stage
            if [ "$STAGE" = "prod" ]; then
              URL="https://ralphwiggums-api.coey.dev"
              DEMO_URL="https://ralphwiggums.coey.dev"
            elif [ "$STAGE" = "staging" ]; then
              URL="https://ralphwiggums-staging.api.coey.dev"
              DEMO_URL="https://ralphwiggums-staging.coey.dev"
            else
              URL="https://${STAGE}.api.coey.dev"
              DEMO_URL="https://${STAGE}.coey.dev"
            fi

            echo "üîÑ Ralph Loop: Checking health at $URL"

            # Check API health endpoint
            API_RESPONSE=$(curl -s -w "\n%{http_code}" -o /dev/null "$URL/health")

            if [ "$API_RESPONSE" = "200" ]; then
              echo "‚úÖ API health check passed!"

              # Also check demo UI
              DEMO_RESPONSE=$(curl -s -w "\n%{http_code}" -o /dev/null "$DEMO_URL")

              if [ "$DEMO_RESPONSE" = "200" ]; then
                echo "‚úÖ Demo UI health check passed!"
                exit 0
              else
                echo "‚ùå Demo UI health check failed: $DEMO_RESPONSE"
                exit 1
              fi
            else
              echo "‚ùå API health check failed: $API_RESPONSE"
              exit 1
            fi

      - name: Run demo test suite on success
        if: steps.health-check.outputs.success == 'true'
        run: |
          STAGE="${{ env.STAGE }}"

          if [ "$STAGE" = "prod" ]; then
            DEMO_URL="https://ralphwiggums.coey.dev"
          elif [ "$STAGE" = "staging" ]; then
            DEMO_URL="https://ralphwiggums-staging.coey.dev"
          else
            DEMO_URL="https://${STAGE}.coey.dev"
          fi

          echo "üß™ Testing demo at $DEMO_URL"
          bun run test:demo --url="$DEMO_URL"

      - name: Comment PR with status (if PR)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.health-check.outcome }}' === 'success' ? '‚úÖ Success' : '‚ùå Failed';
            const stage = '${{ env.STAGE }}';
            const attempts = '${{ steps.health-check.outputs.attempt }}' || 'unknown';

            const comment = `## Deployment Status - Ralph Loop

            **Stage:** ${stage}
            **Status:** ${status}
            **Attempts:** ${attempts} / 5

            **API URL:** https://${stage}.api.coey.dev
            **Demo URL:** https://${stage}.coey.dev

            ---
            *Ralph Loop completed with error retry loop (max 5 retries)*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  auto-heal:
    name: Auto-heal Failed Deployment
    needs: [deploy]
    if: failure() && needs.deploy.result == 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Retry deployment (Auto-heal)
        run: |
          echo "üîß Auto-healing: Retrying deployment for stage ${{ env.STAGE }}"
          bun alchemy deploy --stage ${{ env.STAGE }}
        env:
          STAGE: ${{ env.STAGE }}
          ALCHEMY_PASSWORD: ${{ secrets.ALCHEMY_PASSWORD }}
          ALCHEMY_STATE_TOKEN: ${{ secrets.ALCHEMY_STATE_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ZEN_API_KEY: ${{ secrets.ZEN_API_KEY }}
          RALPH_API_KEY: ${{ secrets.RALPH_API_KEY }}
          PULL_REQUEST: ${{ github.event.number }}
          GITHUB_SHA: ${{ github.sha }}
          ALCHEMY_CI_STATE_STORE_CHECK: false

      - name: Wait for deployment
        run: sleep 30

      - name: Verify auto-heal success
        run: |
          STAGE="${{ env.STAGE }}"
          if [ "$STAGE" = "prod" ]; then
            URL="https://ralphwiggums-api.coey.dev"
          elif [ "$STAGE" = "staging" ]; then
            URL="https://ralphwiggums-staging.api.coey.dev"
          else
            URL="https://${STAGE}.api.coey.dev"
          fi
          
          echo "üîÑ Verifying auto-healed deployment at $URL"
          RESPONSE=$(curl -s -w "\n%{http_code}" -o /dev/null "$URL/health")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Auto-heal successful!"
            exit 0
          else
            echo "‚ùå Auto-heal failed: $RESPONSE"
            exit 1
          fi

  cleanup:
    name: Cleanup PR Preview
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Safety Check
        run: |
          STAGE="pr-${{ github.event.number }}"
          if [ "$STAGE" = "prod" ]; then
            echo "üö® SAFETY ERROR: Attempting to destroy prod environment!"
            exit 1
          fi
          echo "üßπ Cleaning up stage: $STAGE"

      - name: Destroy Preview Environment
        run: bun alchemy destroy --stage pr-${{ github.event.number }}
        env:
          STAGE: pr-${{ github.event.number }}
          ALCHEMY_PASSWORD: ${{ secrets.ALCHEMY_PASSWORD }}
          ALCHEMY_STATE_TOKEN: ${{ secrets.ALCHEMY_STATE_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ALCHEMY_CI_STATE_STORE_CHECK: false
          ALCHEMY_DISABLE_STATE_STORE: true
